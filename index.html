<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  ESP32 Home Automation - Secure Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ </text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Configuration Modal (shown when needed) -->
    <div id="configModal" class="modal hidden">
        <!-- Configuration form will be injected here -->
    </div>

    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">ğŸ  Home Automation</h1>
                <p class="login-subtitle">Secure Access Dashboard</p>
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">ğŸ“§ Email Address:</label>
                    <input type="email" id="email" required placeholder="your@example.com">
                </div>
                
                <div class="form-group">
                    <label for="password">ğŸ” Password:</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                
                <button type="submit" class="login-btn">
                    <span class="btn-text">ğŸ” Sign In Securely</span>
                </button>
            </form>
            
            <div class="login-footer">
                <p class="security-note">ğŸ”’ All communications are encrypted and secure</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="dashboard-container hidden">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 id="dashboardTitle">ğŸ  My Devices Dashboard</h1>
                    <div class="dashboard-stats">
                        <span class="stat">ğŸ“± <span id="deviceCount">0</span> Devices</span>
                        <span class="stat">ğŸ‘¤ Personal Dashboard</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-details">
                            <span class="user-email" id="userEmail">user@example.com</span>
                            <span class="user-role" id="userRole">USER</span>
                        </div>
                        <div class="user-actions">
                            <button class="settings-btn" onclick="showSettingsModal()" title="Settings">âš™ï¸</button>
                            <button class="logout-btn" onclick="authManager.signOut()">
                                ğŸšª Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Enhanced Admin Panel -->
        <div id="adminPanel" class="admin-panel hidden">
            <div class="admin-header">
                <h2 class="admin-title">ğŸ‘‘ Admin Control Panel</h2>
                <p class="admin-subtitle">Manage users, monitor system, and control access</p>
            </div>
            
            <div class="admin-content">
                <!-- System Statistics -->
                <div class="admin-section">
                    <h3>ğŸ“Š System Overview</h3>
                    <div id="systemStatsContainer">
                        <!-- Stats will be populated by admin.js -->
                    </div>
                </div>
                
                <!-- Add New User -->
                <div class="admin-section">
                    <h3>â• Add New User</h3>
                    <form id="addUserForm" onsubmit="handleAddUserSubmit(event)" class="add-user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserEmail">ğŸ“§ Email Address:</label>
                                <input type="email" id="newUserEmail" placeholder="user@example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newUserPassword">ğŸ” Password:</label>
                                <input type="password" id="newUserPassword" placeholder="Minimum 6 characters" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newUserRole">ğŸ‘¤ Role:</label>
                                <select id="newUserRole" required>
                                    <option value="user">User</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="add-user-btn">
                                â• Add User
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- User Management -->
                <div class="admin-section">
                    <div class="section-header">
                        <h3>ğŸ‘¥ User Management</h3>
                        <div class="section-actions">
                            <button onclick="exportUsers()" class="export-btn">ğŸ“¤ Export Users</button>
                            <button onclick="exportStats()" class="export-btn">ğŸ“Š Export Stats</button>
                        </div>
                    </div>
                    <div id="adminUserTable">
                        <!-- User table will be populated by admin.js -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Grid -->
        <main class="dashboard-main">
            <div id="devicesGrid" class="devices-grid">
                <!-- Devices will be populated here -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <span>Last updated: <span id="lastUpdate">-</span></span>
                    <span>ğŸ”’ Secure Connection</span>
                </div>
                <div class="footer-links">
                    <a href="#" onclick="showHelp()">â“ Help</a>
                    <a href="#" onclick="showSettings()">âš™ï¸ Settings</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Loading Screen -->
    <div id="loadingContainer" class="loading-container hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>ğŸ”„ Loading your dashboard...</h2>
            <p>Establishing secure connection...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="dashboard.js"></script>
    <script src="admin.js"></script>

    <!-- Main Application -->
    <script>
        // Main application initialization
        class HomeAutomationApp {
            constructor() {
                this.initialized = false;
            }

            async initialize() {
                try {
                    console.log('ğŸš€ Initializing ESP32 Home Automation Dashboard');
                    
                    // Wait for configuration
                    if (!window.appConfig.isConfigured()) {
                        console.log('âš™ï¸ Waiting for configuration...');
                        return; // Configuration modal will handle this
                    }

                    // Initialize authentication
                    await window.authManager.initialize();
                    
                    // Initialize dashboard manager
                    window.dashboardManager = new DashboardManager(window.authManager);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    this.initialized = true;
                    console.log('âœ… Application initialized successfully');
                    
                } catch (error) {
                    console.error('âŒ Application initialization failed:', error);
                    this.showError('Failed to initialize application: ' + error.message);
                }
            }

            setupEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // Auth state changes
                if (window.authManager.auth) {
                    window.authManager.auth.onAuthStateChanged(async (user) => {
                        if (user && window.dashboardManager) {
                            await window.dashboardManager.initialize();
                        }
                    });
                }
            }

            async handleLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                this.showError(''); // Clear previous errors
                
                try {
                    const result = await window.authManager.signIn(email, password);
                    if (!result.success) {
                        this.showError(result.error);
                    }
                } catch (error) {
                    this.showError('Login failed: ' + error.message);
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                if (message) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                } else {
                    errorDiv.classList.add('hidden');
                }
            }

            showNotification(message, type) {
                if (window.dashboardManager) {
                    window.dashboardManager.showNotification(message, type);
                }
            }
        }

        // Global helper functions
        function showHelp() {
            const helpModal = document.createElement('div');
            helpModal.innerHTML = `
                <div class="config-modal-overlay">
                    <div class="config-modal-content">
                        <h2>â“ Help & Support</h2>
                        <div class="help-sections">
                            <h3>ğŸ  ESP32 Device Setup</h3>
                            <ol>
                                <li>Power on your ESP32 device</li>
                                <li>Connect to WiFi: <strong>ESP32_HomeAutomation_Setup</strong></li>
                                <li>Open browser: <strong>http://192.168.4.1</strong></li>
                                <li>Complete setup with your dashboard email</li>
                            </ol>
                            
                            <h3>ğŸ›ï¸ Dashboard Controls</h3>
                            <ul>
                                <li><strong>Click relays</strong> to toggle ON/OFF</li>
                                <li><strong>Use PWM slider</strong> for dimming control</li>
                                <li><strong>Hold switch on device</strong> for PWM mode</li>
                                <li><strong>Monitor sensors</strong> in real-time</li>
                            </ul>
                            
                            <h3>ğŸ‘‘ Admin Features (Admins only)</h3>
                            <ul>
                                <li>Add new users to the system</li>
                                <li>View all devices regardless of owner</li>
                                <li>Export user and system data</li>
                                <li>Monitor system statistics</li>
                            </ul>
                            
                            <h3>ğŸ”’ Security & Privacy</h3>
                            <ul>
                                <li>All data is encrypted in transit</li>
                                <li>Users can only see their own devices</li>
                                <li>Firebase credentials stored locally only</li>
                                <li>Admin access required for user management</li>
                            </ul>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="close-btn">âœ–ï¸ Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(helpModal);
        }

        function showSettingsModal() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="config-modal-overlay">
                    <div class="config-modal-content">
                        <h2>âš™ï¸ Dashboard Settings</h2>
                        <div class="settings-options">
                            <button onclick="reconfigureFirebase()" class="settings-option">
                                ğŸ”§ Reconfigure Firebase
                            </button>
                            <button onclick="clearAllData()" class="settings-option danger">
                                ğŸ—‘ï¸ Clear All Settings
                            </button>
                            <button onclick="exportSettings()" class="settings-option">
                                ğŸ“¤ Export Settings
                            </button>
                            <button onclick="showDeviceInfo()" class="settings-option">
                                ğŸ“‹ Device Information
                            </button>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="close-btn">âŒ Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function reconfigureFirebase() {
            if (confirm('This will clear your current Firebase configuration. Continue?')) {
                window.appConfig.clearConfiguration();
                window.location.reload();
            }
        }

        function clearAllData() {
            if (confirm('âš ï¸ This will clear ALL stored data including login sessions. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            }
        }

        function exportSettings() {
            const settings = {
                user: window.authManager?.getCurrentUser()?.email || 'unknown',
                role: window.authManager?.getRole() || 'user',
                deviceCount: Object.keys(window.dashboardManager?.userDevices || {}).length,
                exportTime: new Date().toISOString()
            };
            
            const json = JSON.stringify(settings, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'dashboard-settings.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showDeviceInfo() {
            const info = `
                Dashboard Version: 2.0.0
                Firebase SDK: 9.22.0
                Browser: ${navigator.userAgent}
                Screen: ${screen.width}x${screen.height}
                Connection: ${navigator.onLine ? 'Online' : 'Offline'}
                Platform: ${navigator.platform}
            `;
            alert(info);
        }

        // Admin functions (called from admin.js)
        async function handleAddUserSubmit(event) {
            event.preventDefault();
            if (window.adminManager) {
                await window.adminManager.handleAddUser();
            }
        }

        function exportUsers() {
            if (window.adminManager) {
                window.adminManager.exportUsersData();
            }
        }

        function exportStats() {
            if (window.adminManager) {
                window.adminManager.exportSystemStats();
            }
        }

        // Initialize application
        const app = new HomeAutomationApp();
        
        // Start initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.initialize());
        } else {
            app.initialize();
        }

        // Auto-retry initialization if configuration becomes available
        const configCheckInterval = setInterval(() => {
            if (!app.initialized && window.appConfig?.isConfigured()) {
                clearInterval(configCheckInterval);
                app.initialize();
            }
        }, 1000);

        // Service worker registration for PWA capabilities (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        console.log('ğŸ” ESP32 Home Automation - Secure Dashboard Loaded');
    </script>
</body>
</html>
