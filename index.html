<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  ESP32 Home Automation Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ </text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">ğŸ  Smart Home</h1>
                <p class="login-subtitle">Secure Access Dashboard</p>
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">ğŸ“§ Email Address:</label>
                    <input type="email" id="email" required placeholder="your@example.com">
                </div>
                
                <div class="form-group">
                    <label for="password">ğŸ” Password:</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                
                <button type="submit" class="login-btn">
                    ğŸ” Sign In Securely
                </button>
            </form>
            
            <div class="login-footer">
                <p class="security-note">ğŸ”’ All communications are encrypted and secure</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="dashboard-container hidden">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 id="dashboardTitle">ğŸ  My Smart Home</h1>
                    <div class="dashboard-stats">
                        <span class="stat">ğŸ“± <span id="deviceCount">0</span> Devices</span>
                        <span class="stat">âš¡ <span id="onlineCount">0</span> Online</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-details">
                            <span class="user-email" id="userEmail">user@example.com</span>
                            <span class="user-role" id="userRole">USER</span>
                        </div>
                        <div class="user-actions">
                            <button class="settings-btn" onclick="showSettingsModal()" title="Settings">âš™ï¸</button>
                            <button class="logout-btn" onclick="logout()">ğŸšª Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel hidden">
            <div class="admin-header">
                <h2 class="admin-title">ğŸ‘‘ Admin Control Panel</h2>
                <p class="admin-subtitle">Manage users and monitor system</p>
            </div>
            
            <div class="admin-content">
                <!-- System Statistics -->
                <div class="admin-section">
                    <h3>ğŸ“Š System Overview</h3>
                    <div id="systemStatsContainer" class="system-stats-grid">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Add New User -->
                <div class="admin-section">
                    <h3>â• Add New User</h3>
                    <form id="addUserForm" class="add-user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserEmail">ğŸ“§ Email Address:</label>
                                <input type="email" id="newUserEmail" placeholder="user@example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newUserPassword">ğŸ” Password:</label>
                                <input type="password" id="newUserPassword" placeholder="Minimum 6 characters" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newUserRole">ğŸ‘¤ Role:</label>
                                <select id="newUserRole" required>
                                    <option value="user">User</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="add-user-btn">â• Add User</button>
                        </div>
                    </form>
                </div>
                
                <!-- User Management -->
                <div class="admin-section">
                    <div class="section-header">
                        <h3>ğŸ‘¥ User Management</h3>
                        <div class="section-actions">
                            <button onclick="exportUsers()" class="export-btn">ğŸ“¤ Export Users</button>
                        </div>
                    </div>
                    <div id="adminUserTable">
                        <!-- User table will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Grid -->
        <main class="dashboard-main">
            <div id="devicesGrid" class="devices-grid">
                <!-- Devices will be populated here -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-info">
                    <span>Last updated: <span id="lastUpdate">-</span></span>
                    <span>ğŸ”’ Secure Connection</span>
                </div>
                <div class="footer-links">
                    <a href="#" onclick="showHelp()">â“ Help</a>
                    <a href="https://github.com/yourusername/esp32-home-automation" target="_blank">ğŸ“š GitHub</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Loading Screen -->
    <div id="loadingContainer" class="loading-container hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>ğŸ”„ Loading your dashboard...</h2>
            <p>Establishing secure connection...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="dashboard.js"></script>
    <script src="admin.js"></script>

    <!-- Main Application -->
    <script>
        // Main Application Controller
        class SmartHomeApp {
            constructor() {
                this.initialized = false;
                this.config = null;
                this.auth = null;
                this.dashboard = null;
                this.admin = null;
            }

            async initialize() {
                try {
                    console.log('ğŸš€ Initializing Smart Home Dashboard');
                    
                    // Wait for configuration
                    this.config = await window.configManager.initialize();
                    if (!this.config) {
                        console.log('âš™ï¸ Waiting for configuration...');
                        return;
                    }

                    // Initialize authentication
                    this.auth = new AuthManager(this.config);
                    await this.auth.initialize();
                    
                    // Initialize dashboard
                    this.dashboard = new DashboardManager(this.auth);
                    
                    // Initialize admin (if needed)
                    this.admin = new AdminManager(this.auth, this.dashboard);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    this.initialized = true;
                    console.log('âœ… Smart Home Dashboard initialized successfully');
                    
                } catch (error) {
                    console.error('âŒ Application initialization failed:', error);
                    this.handleError(error);
                }
            }

            setupEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // Auth state observer
                this.auth.onAuthStateChanged((user) => {
                    if (user && this.dashboard) {
                        this.dashboard.initialize();
                        if (this.auth.isAdmin) {
                            this.admin.initialize();
                        }
                    }
                });

                // Add user form
                document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (this.admin) {
                        await this.admin.handleAddUser();
                    }
                });
            }

            async handleLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                this.clearError();
                
                try {
                    const result = await this.auth.signIn(email, password);
                    if (!result.success) {
                        this.showError(result.error);
                    }
                } catch (error) {
                    this.showError('Login failed: ' + error.message);
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }

            clearError() {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.classList.add('hidden');
            }

            handleError(error) {
                if (error.message.includes('configuration')) {
                    window.configManager.showConfigModal();
                } else {
                    this.showError('System error: ' + error.message);
                }
            }
        }

        // Global helper functions
        function showSettingsModal() {
            window.configManager.showSettingsModal();
        }

        function showHelp() {
            const helpContent = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h2>â“ Smart Home Dashboard Help</h2>
                        <div class="help-sections">
                            <h3>ğŸ  ESP32 Device Setup</h3>
                            <ol>
                                <li>Power on your ESP32 device</li>
                                <li>Connect to WiFi: <strong>ESP32_HomeAutomation_Setup</strong></li>
                                <li>Password: <strong>homesetup123</strong></li>
                                <li>Open browser: <strong>http://192.168.4.1</strong></li>
                                <li>Complete setup with your dashboard email</li>
                            </ol>
                            
                            <h3>ğŸ›ï¸ Device Control</h3>
                            <ul>
                                <li><strong>Click relays</strong> to toggle ON/OFF</li>
                                <li><strong>Use PWM slider</strong> for dimming</li>
                                <li><strong>Monitor sensors</strong> in real-time</li>
                                <li><strong>Check online status</strong> of devices</li>
                            </ul>
                            
                            <h3>ğŸ‘‘ Admin Features</h3>
                            <ul>
                                <li>Add new users to the system</li>
                                <li>View all devices and users</li>
                                <li>Export system data</li>
                                <li>Monitor system statistics</li>
                            </ul>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()">âœ–ï¸ Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', helpContent);
        }

        function logout() {
            if (window.app && window.app.auth) {
                window.app.auth.signOut();
            }
        }

        function exportUsers() {
            if (window.app && window.app.admin) {
                window.app.admin.exportUsers();
            }
        }

        // Initialize application
        window.app = new SmartHomeApp();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => window.app.initialize());
        } else {
            window.app.initialize();
        }

        console.log('ğŸ  Smart Home Dashboard loaded');
    </script>
</body>
</html>
